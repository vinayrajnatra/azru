
$location = "South India"
$myStorageAccountName = "gen01storageacntdemo"
$resourcegroupName = "GEN_ITMS_DEMO_LB_01"


$resourcegroup = New-AzureRmResourceGroup -Name $resourcegroupName  -location $location

$backendSubnet = New-AzureRmVirtualNetworkSubnetConfig -Name LB-Subnet-BE -AddressPrefix 10.0.2.0/24

New-AzureRmvirtualNetwork -Name NRPVNet -ResourceGroupName $resourcegroupName -Location $location -AddressPrefix 10.0.0.0/16 -Subnet $backendSubnet

$publicIP = New-AzureRmPublicIpAddress -Name PublicIp -ResourceGroupName $resourcegroupName -Location $location -AllocationMethod Static -DomainNameLabel gentestlb 
 

 
$frontendIP = New-AzureRmLoadBalancerFrontendIpConfig -Name LB-Frontend -PublicIpAddress $publicIP

$beaddresspool = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name LB-backend


$inboundNATRule1= New-AzureRmLoadBalancerInboundNatRuleConfig -Name RDP1 -FrontendIpConfiguration $frontendIP -Protocol TCP -FrontendPort 3441 -BackendPort 3389

$inboundNATRule2= New-AzureRmLoadBalancerInboundNatRuleConfig -Name RDP2 -FrontendIpConfiguration $frontendIP -Protocol TCP -FrontendPort 3442 -BackendPort 3389



$healthProbe = New-AzureRmLoadBalancerProbeConfig -Name HealthProbe -RequestPath 'Sample.html' -Protocol http -Port 80 -IntervalInSeconds 15 -ProbeCount 2

 
--Loadbalancerrule

$lbrule = New-AzureRmLoadBalancerRuleConfig -Name HTTP -FrontendIpConfiguration $frontendIP -BackendAddressPool  $beAddressPool -Probe $healthProbe -Protocol Tcp -FrontendPort 80 -BackendPort 80

--Create Load Balancer

$NRPLB = New-AzureRmLoadBalancer -ResourceGroupName $resourcegroupName -Name NRP-LB -Location $location -FrontendIpConfiguration $frontendIP -InboundNatRule $inboundNATRule1,$inboundNatRule2 -LoadBalancingRule $lbrule -BackendAddressPool $beAddressPool -Probe $healthProbe
 

$vnet = Get-AzureRmVirtualNetwork -Name NRPVNet -ResourceGroupName $resourcegroupName
$backendSubnet = Get-AzureRmVirtualNetworkSubnetConfig -Name LB-Subnet-BE -VirtualNetwork $vnet


--Creating NIC Interface
$backendnic1= New-AzureRmNetworkInterface -ResourceGroupName $resourcegroupName -Name lb-nic1-be -Location $location -PrivateIpAddress 10.0.2.6 -Subnet $backendSubnet -LoadBalancerBackendAddressPool $nrplb.BackendAddressPools[0] -LoadBalancerInboundNatRule $nrplb.InboundNatRules[0]

$backendnic2= New-AzureRmNetworkInterface -ResourceGroupName $resourcegroupName -Name lb-nic2-be -Location $location -PrivateIpAddress 10.0.2.7 -Subnet $backendSubnet -LoadBalancerBackendAddressPool $nrplb.BackendAddressPools[0] -LoadBalancerInboundNatRule $nrplb.InboundNatRules[1]




$myStorageAccount = New-AzureRmStorageAccount -ResourceGroupName $resourceGroupName -Name $myStorageAccountName -Type "Standard_LRS"  -Location $location

$availabilityset = New-AzureRmAvailabilitySet -ResourceGroupName $resourceGroupName -Name "genlbavlset" -Location $location -managed

$cred = Get-Credential -Message "p@ssw0rd@microsoft"
 
$myVm01 = New-AzureRmVMConfig -VMName "vm01" -VMSize "Standard_DS1_v2" -AvailabilitySetId $availabilityset.Id
	 
$myVm01 = Set-AzureRmVMOperatingSystem -VM $myVm01 -Windows -ComputerName "myVM" -Credential $cred -ProvisionVMAgent -EnableAutoUpdate
	 
	 
$myVm01 = Set-AzureRmVMSourceImage -VM $myVm01 -PublisherName "MicrosoftWindowsServer" -Offer "WindowsServer" -Skus "2012-R2-Datacenter" -Version "latest"

$backendnic1 = Get-AzureRMNetworkInterface -Name lb-nic1-be -ResourceGroupName $resourceGroupName
	 
$myVm01 = Add-AzureRmVMNetworkInterface -VM $myVm01 -Id $backendnic1.Id

	 
$blobPath = "vhds/myOsDisk1.vhd"
$osDiskUri = $myStorageAccount.PrimaryEndpoints.Blob.ToString() + $blobPath

 
$myVM01 = Set-AzureRmVMOSDisk -VM $myVM01 -Name "myOsDisk" -VhdUri $osDiskUri -CreateOption fromImage

New-AzureRmVM -ResourceGroupName $resourceGroupName -Location $location -VM $myVM01



$cred = Get-Credential -Message "p@ssw0rd@microsoft"
 
$myVm02 = New-AzureRmVMConfig -VMName "vm02" -VMSize "Standard_DS1_v2" -AvailabilitySetId $availabilityset.Id
	 
$myVm02 = Set-AzureRmVMOperatingSystem -VM $myVm02 -Windows -ComputerName "myVM" -Credential $cred -ProvisionVMAgent -EnableAutoUpdate
	 
	 
$myVm02 = Set-AzureRmVMSourceImage -VM $myVm02 -PublisherName "MicrosoftWindowsServer" -Offer "WindowsServer" -Skus "2012-R2-Datacenter" -Version "latest"

$backendnic2 = Get-AzureRMNetworkInterface -Name lb-nic2-be -ResourceGroupName $resourceGroupName
	 
$myVm02 = Add-AzureRmVMNetworkInterface -VM $myVm02 -Id $backendnic2.Id

	 
$blobPath = "vhds/myOsDisk2.vhd"
$osDiskUri = $myStorageAccount.PrimaryEndpoints.Blob.ToString() + $blobPath

 
$myVM02 = Set-AzureRmVMOSDisk -VM $myVM02 -Name "myOsDisk1" -VhdUri $osDiskUri -CreateOption fromImage

New-AzureRmVM -ResourceGroupName $resourceGroupName -Location $location -VM $myVM02

 
 